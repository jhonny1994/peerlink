rules_version = '2';

// PeerLink Firestore Security Rules
// Optimized for Firebase free tier with client-side session management
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if session is expired (15 minutes)
    function isSessionExpired() {
      return request.time > resource.data.createdAt + duration.value(15, 'm');
    }
    
    // Helper function to validate session data structure
    function isValidSession() {
      return request.resource.data.keys().hasAll(['sessionId', 'code', 'createdAt', 'expiresAt'])
        && request.resource.data.sessionId is string
        && request.resource.data.code is string
        && request.resource.data.code.size() == 6
        && request.resource.data.createdAt is timestamp
        && request.resource.data.expiresAt is timestamp;
    }
    
    // Sessions collection for WebRTC signaling
    match /sessions/{sessionId} {
      // Allow anyone to read sessions (needed for receiver to get session by code)
      // Security: Session codes are 6 digits (1M combinations), 15-min expiry
      allow read: if true;
      
      // Allow anyone to create a new session with valid data
      // Validates: structure, expiry time within bounds (< 20 minutes)
      allow create: if isValidSession()
        && request.resource.data.expiresAt > request.time
        && request.resource.data.expiresAt < request.time + duration.value(20, 'm');
      
      // Allow updates to add ICE candidates, answer, and receiver ready flag
      // Only if the document exists and is not expired
      allow update: if request.time < resource.data.expiresAt
        && !isSessionExpired();
      
      // Allow deletion of sessions (for client-side cleanup)
      // Free tier alternative to server-side TTL
      // SECURITY FIX: Disabled client-side delete to prevent DoS. 
      // Rely on TTL or scheduled functions for cleanup.
      allow delete: if false;
    }
    
    // Deny all other collections by default
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
